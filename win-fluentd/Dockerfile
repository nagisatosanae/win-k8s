# AUTOMATICALLY GENERATED
# DO NOT EDIT THIS FILE DIRECTLY, USE /Dockerfile.template.erb

FROM mcr.microsoft.com/dotnet/framework/runtime:4.8-windowsservercore-ltsc2019 as core
LABEL maintainer "Fluentd developers <fluentd@googlegroups.com>"
LABEL Description="Fluentd docker image" Vendor="Fluent Organization" Version="1.16.2"

# Do not split this into multiple RUN!
# Docker creates a layer for every RUN-Statement
RUN powershell -Command "Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))"

# RUN dir
# COPY install-choco.ps1 install-choco.ps1
# RUN powershell -Command "Set-ExecutionPolicy Bypass -Scope Process -Force; .\install-choco.ps1"
# RUN dir

# NOTE: For avoiding stalling with docker build on windows, we must use latest version of msys2.
RUN choco install -y ruby --version 3.1.3.1 --params "'/InstallDir:C:\ruby31'" \
&& choco install -y msys2 --version 20230318.0.0 --params "'/NoPath /NoUpdate /InstallDir:C:\ruby31\msys64'"
RUN refreshenv \
&& ridk install 3 \
&& echo gem: --no-document >> C:\ProgramData\gemrc \
&& gem install oj -v 3.15.0 \
&& gem install json -v 2.6.3 \
&& gem install rexml -v 3.2.5 \
&& gem install fluentd -v 1.16.2 \
&& gem install win32-service -v 2.3.2 \
&& gem install win32-ipc -v 0.7.0 \
&& gem install win32-event -v 0.6.3 \
&& gem sources --clear-all

# Remove gem cache and chocolatey
RUN powershell -Command "Remove-Item -Force C:\ruby31\lib\ruby\gems\3.1.0\cache\*.gem; Remove-Item -Recurse -Force 'C:\ProgramData\chocolatey'"


WORKDIR /dist
COPY zip.exe ./zip.exe
RUN zip -9vr c:/dist/ruby31.zip c:/ruby31


# 권한도 해도 똑같네
# RUN powershell -Command "cd c:\ruby31; Get-ChildItem -Recurse | ForEach-Object {icacls $_.FullName /grant Everyone:F /T /Q}"







FROM mcr.microsoft.com/windows/nanoserver:ltsc2019 as final
COPY --from=core /dist/ruby31.zip .

COPY fluent.conf /fluent/conf/fluent.conf

COPY unzip.exe unzip.exe
COPY 7zr.exe 7zr.exe

# RUN unzip.exe ruby31.zip

ENV FLUENTD_CONF="fluent.conf"
ENV Path="${Path};C:\\ruby31\\bin"

EXPOSE 24224 5140

# ENTRYPOINT ["cmd", "/k", "fluentd", "--config", "C:\\fluent\\conf\\fluent.conf"]
CMD [ "ping", "localhost", "-t" ]